#SSM练习 第2天
##课程大纲
### 第1章 SSM整合
#### 1.1 数据库与表结构
产品表信息描述

| 序号   | 字段名称          | 字段类型          | 字段描述          |
| ---- | ------------- | ------------- | ------------- |
| 1    | id            | number        | 主键，自动增长       |
| 2    | productNum    | varchar2(50)  | 产品编号，唯一，不为空   |
| 3    | productName   | varchar2(50)  | 产品名称（路线名称）    |
| 4    | cityName      | varchar2(50)  | 出发城市          |
| 5    | departureTime | timestamp     | 出发时间          |
| 6    | productPrice  | number(8,2)   | 产品价格          |
| 7    | productDesc   | varchar2(500) | 产品描述          |
| 8    | productStatus | number(1)     | 状态（0：关闭，1：开启） |

#### 1.2 创建表空间

```plsql
--创建表空间
create tablespace ssm43
datafile 'c:\ssm43.dbf'
size 10m
autoextend on
next 10m;
```

#### 1.3 创建用户与授权

```plsql
--创建用户
create user ssm43 identified by ssm43 default tablespace ssm43;

--授权
grant dba to ssm43;
```

#### 1.4 创建表

创建表sql，为了方便实现主键自增，我们这里创建序列。

```plsql
--建表
create table product(
       id number(20) primary key,
       productNum varchar2(50),
       productName varchar2(50),
       cityName varchar2(50),
       DepartureTime date,
       productPrice number(8,2),
       productDesc varchar2(500),
       productStatus number(1)
);

--创建序列
create sequence product_seq;

--插入测试数据
insert into PRODUCT (id, productnum, productname, cityname, departuretime, productprice, productdesc, productstatus)
values (product_seq.NEXTVAL, '001', '西冲1日游', '深圳', to_date('22-08-2018 08:00:00', 'dd-mm-yyyy hh24:mi:ss'), 294, '畅游西冲，体验潜水，快艇冲浪，烧烤BBQ，海边戏水游玩', 1);
insert into PRODUCT (id, productnum, productname, cityname, departuretime, productprice, productdesc, productstatus)
values (product_seq.NEXTVAL, '002', '西冲1日游', '深圳', to_date('07-08-2018 08:30:00', 'dd-mm-yyyy hh24:mi:ss'), 88, '专车专导，畅游西冲，烧烤BBQ，快艇冲浪', 1);
insert into PRODUCT (id, productnum, productname, cityname, departuretime, productprice, productdesc, productstatus)
values (product_seq.NEXTVAL, '003', '南澳西冲1日游', '深圳', to_date('22-08-2018 07:50:00', 'dd-mm-yyyy hh24:mi:ss'), 98, '杨梅坑美人鱼拍摄基地 BBQ海边烧烤 、快艇冲浪与CS野战', 1);
insert into PRODUCT (id, productnum, productname, cityname, departuretime, productprice, productdesc, productstatus)
values (product_seq.NEXTVAL, '004', '西冲沙滩1日游', '深圳', to_date('22-08-2018 08:00:00', 'dd-mm-yyyy hh24:mi:ss'), 86, '杨梅坑单车 BBQ海边烧烤 CS野战', 1);
insert into PRODUCT (id, productnum, productname, cityname, departuretime, productprice, productdesc, productstatus)
values (product_seq.NEXTVAL, '005', '南澳西冲1日游', '深圳', to_date('22-08-2018 09:00:00', 'dd-mm-yyyy hh24:mi:ss'), 78, '八千人出游、好评达9成、快艇上情人岛、杨梅坑环海骑行、观美人鱼拍摄基地、海边BBQ、海边戏水游玩', 1);
insert into PRODUCT (id, productnum, productname, cityname, departuretime, productprice, productdesc, productstatus)
values (product_seq.NEXTVAL, 'No.001', '深圳一日', '深圳', to_date('04-09-2018 09:45:00', 'dd-mm-yyyy hh24:mi:ss'), 99, 'asdfasdf', 1);
commit;
```

### 第2章 创建Maven工程
1. 创建ssm_parent父工程（打包方式选择pom，必须的）
2. 创建ssm_web子模块（打包方式是war包）
3. 创建ssm_service子模块（打包方式是jar包）
4. 创建ssm_dao子模块（打包方式是jar包）
5. 创建ssm_domain子模块（打包方式是jar包）
6. 创建ssm_utils子模块（打包方式是jar包）
7. web依赖于service，service依赖于dao，dao依赖于domain，domain依赖utils


#### 2.1 ssm-parent
##### 2.1.1pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.itheima</groupId>
  <artifactId>ssm-parent</artifactId>
  <version>1.0-SNAPSHOT</version>
  <modules>
      <module>ssm-model</module>
      <module>ssm-dao</module>
      <module>ssm-service</module>
      <module>ssm-web</module>
      <module>ssm-util</module>
  </modules>
  <!--打包方式为pom-->
  <packaging>pom</packaging>

  <!--统一管理版本-->
  <properties>
    <spring.version>5.0.2.RELEASE</spring.version>
    <slf4j.version>1.6.6</slf4j.version>
    <log4j.version>1.2.12</log4j.version>
    <oracle.version>10.2.0.1.0</oracle.version>
    <mybatis.version>3.4.5</mybatis.version>
    <aspectjweaver.version>1.6.8</aspectjweaver.version>
    <junit.version>4.12</junit.version>
    <jsp-api.version>2.0</jsp-api.version>
    <servlet-api.version>2.5</servlet-api.version>
    <jstl.version>1.2</jstl.version>
    <mybatis-spring.version>1.3.0</mybatis-spring.version>
    <druid.version>1.0.9</druid.version>
    <jackson-version>2.9.6</jackson-version>
    <!--文件的编码格式-->
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  </properties>
```


```xml
  <!--jar包管理，并不会将jar包导入到工程中-->
  <dependencyManagement>

    <!--引入依赖-->
    <dependencies>
      <!-- spring -->
      <dependency>
        <groupId>org.aspectj</groupId>
        <artifactId>aspectjweaver</artifactId>
        <version>${aspectjweaver.version}</version>
      </dependency>

      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-aop</artifactId>
        <version>${spring.version}</version>
      </dependency>

      <!--spring包-->
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>${spring.version}</version>
      </dependency>

      <!--用于SpringMVC-->
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-webmvc</artifactId>
        <version>${spring.version}</version>
      </dependency>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-web</artifactId>
        <version>${spring.version}</version>
      </dependency>

      <!--用于数据库源相关操作-->
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>${spring.version}</version>
      </dependency>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-tx</artifactId>
        <version>${spring.version}</version>
      </dependency>

      <!--ServletAPI-->
      <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>servlet-api</artifactId>
        <version>${servlet-api.version}</version>
        <scope>provided</scope>
      </dependency>

      <dependency>
        <groupId>javax.servlet.jsp</groupId>
        <artifactId>jsp-api</artifactId>
        <version>${jsp-api.version}</version>
        <scope>provided</scope>
      </dependency>

      <!--jstl标签-->
      <dependency>
        <groupId>jstl</groupId>
        <artifactId>jstl</artifactId>
        <version>${jstl.version}</version>
      </dependency>

      <!--Oracle数据库驱动-->
      <dependency>
        <groupId>com.oracle</groupId>
        <artifactId>ojdbc14</artifactId>
        <version>${oracle.version}</version>
      </dependency>

      <!--测试框架-->
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-test</artifactId>
        <version>${spring.version}</version>
      </dependency>

      <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>${junit.version}</version>
        <scope>compile</scope>
      </dependency>
      <!--
        用于JSON数据转换
        实现Json 互转 JavaBean
    -->
      <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>${jackson-version}</version>
      </dependency>
      <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-core</artifactId>
        <version>${jackson-version}</version>
      </dependency>
      <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-annotations</artifactId>
        <version>${jackson-version}</version>
      </dependency>
      <!-- log start -->
      <dependency>
        <groupId>log4j</groupId>
        <artifactId>log4j</artifactId>
        <version>${log4j.version}</version>
      </dependency>

      <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-api</artifactId>
        <version>${slf4j.version}</version>
      </dependency>

      <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-log4j12</artifactId>
        <version>${slf4j.version}</version>
      </dependency>
      <!-- log end -->

      <!--mybatis-->
      <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>${mybatis.version}</version>
      </dependency>

      <!--MyBatis集成Spring-->
      <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>${mybatis-spring.version}</version>
      </dependency>

      <!--数据源-->
      <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>${druid.version}</version>
      </dependency>
    </dependencies>
  </dependencyManagement>
	<build>
        <!--插件-->
        <plugins>
            <!--tomcat插件-->
            <plugin>
                <groupId>org.apache.tomcat.maven</groupId>
                <artifactId>tomcat7-maven-plugin</artifactId>
                <version>2.2</version>
                <!--插件使用的相关配置-->
                <configuration>
                    <!--端口号-->
                    <port>18081</port>
                    <!--写当前项目的名字(虚拟路径),如果写/，那么每次访问项目就不需要加项目名字了-->
                    <path>/</path>
                    <!--解决get请求乱码-->
                    <uriEncoding>UTF-8</uriEncoding>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```


##### 2.1.2 创建工具包工程
紧接着我们把ssm-util也创建了，该工程用于提供工具类的。
创建jar包工程，名字叫ssm-util,集成ssm-parent

在其中创建一个类，提供时间转字符串类型。


```java
package com.itheima.util;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * 日期处理工具
 */
public class DateUtil {
    public static SimpleDateFormat ymdHms = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    public static SimpleDateFormat ymdHm = new SimpleDateFormat("yyyy-MM-dd HH:mm");
    public static SimpleDateFormat ymd = new SimpleDateFormat("yyyy-MM-dd");

    /**
     * 格式化日期
     * @param date
     * @param format
     * @return
     */
    public static String date2Str(Date date, String format){
        SimpleDateFormat sdf = new SimpleDateFormat(format);
        return sdf.format(date);
    }

    public static String date2Str(Date date, DateFormat format){
        return format.format(date);
    }
}
```

#### 2.2 ssm-domain
创建Product即可

```java
package com.itheima.domain;

public class Product {
    private Integer id;
    private String productNum;
    private String productName;
    private String cityName;
    private Date departureTime;
    private Float productPrice;
    private String productDesc;
    private int productStatus;
	//get..set..
}
```

在ssm-domain的pom.xml中引入spring以及工具包的依赖	
```xml
<!--依赖工具包-->
<dependencies>
	<!--工具包-->
    <dependency>
        <groupId>com.itheima</groupId>
        <artifactId>ssm-util</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
	
	<!--Spring-->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <scope>provided</scope>
    </dependency>
</dependencies>
```

#### 2.3 ssm-dao

##### 2.2.1 pom.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ssm-parent</artifactId>
        <groupId>com.itheima</groupId>
        <version>1.0-SNAPSHOT</version>
        <relativePath>../ssm-parent/pom.xml</relativePath>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ssm-dao</artifactId>

    <!--引入依赖-->
    <dependencies>
        <!--model的依赖-->
        <dependency>
            <groupId>com.itheima</groupId>
            <artifactId>ssm-model</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

        <!--mybatis-->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
        </dependency>

        <!--MyBatis集成Spring-->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis-spring</artifactId>
        </dependency>

        <!--数据源-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
        </dependency>

        <!--Oracle数据库驱动-->
        <dependency>
            <groupId>com.oracle</groupId>
            <artifactId>ojdbc14</artifactId>
        </dependency>
              <!--SpringJdbc -->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-jdbc</artifactId>
        </dependency>

        <!-- log start -->
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
        </dependency>

        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
        </dependency>

        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-log4j12</artifactId>
        </dependency>
        <!-- log end -->
    </dependencies>
</project>
```

##### 2.2.2 spring-mybatis.xml

在ssm-dao的resources目录下，创建spring-mybatis.xml文件，内容如下

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- 数据库连接池 -->
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource"
          destroy-method="close">
        <property name="url" value="jdbc:oracle:thin:@192.168.66.166:1521:orcl" />
        <property name="username" value="ssm43" />
        <property name="password" value="ssm43" />
        <property name="driverClassName" value="oracle.jdbc.OracleDriver" />
    </bean>

    <!--SqlSessionFactoryBean-->
    <bean id="sqlSessionFactoryBean" class="org.mybatis.spring.SqlSessionFactoryBean">
        <!--注入数据源-->
        <property name="dataSource" ref="dataSource" />
    </bean>

    <!--接口扫描 MapperScannerConfigurer-->
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <!--指定Dao接口的包-->
        <property name="basePackage" value="com.itheima.dao" />
        <!--
            指定SqlSessionFactoryBeanName
            在多数据源情况下，需要指定
        -->
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactoryBean" />
    </bean>

</beans>
```

##### 2.2.3 ProductDao.java
```java
package com.itheima.dao;

public interface ProductDao {}
```

#### 2.3 ssm-service
##### 2.3.1 pom.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ssm-parent</artifactId>
        <groupId>com.itheima</groupId>
        <version>1.0-SNAPSHOT</version>
        <relativePath>../ssm-parent/pom.xml</relativePath>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>ssm-service</artifactId>
    <!--打包jar-->
    <packaging>jar</packaging>

    <!--引入依赖-->
    <dependencies>
        <!--依赖dao-->
        <dependency>
            <groupId>com.itheima</groupId>
            <artifactId>ssm-dao</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

        <!-- spring -->
        <dependency>
            <groupId>org.aspectj</groupId>
            <artifactId>aspectjweaver</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-aop</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-tx</artifactId>
        </dependency>
    </dependencies>

</project>
```

##### 2.3.2 spring.xml

在ssm-service的resources目录下，创建spring.xml文件，内容如下

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:p="http://www.springframework.org/schema/p"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc" xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop" xmlns:cache="http://www.springframework.org/schema/cache"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd">
  <!-- 事务传播特性配置 -->
    <tx:advice id="txAdvice" transaction-manager="txManager">
        <!-- the transactional semantics... -->
        <tx:attributes>
            <tx:method name="add*" propagation="REQUIRED" isolation="DEFAULT"
                       rollback-for="java.lang.Exception" />
            <tx:method name="save*" propagation="REQUIRED" isolation="DEFAULT"
                       rollback-for="java.lang.Exception" />
            <tx:method name="insert*" propagation="REQUIRED" isolation="DEFAULT"
                       rollback-for="java.lang.Exception" />
            <tx:method name="update*" propagation="REQUIRED" isolation="DEFAULT"
                       rollback-for="java.lang.Exception" />
            <tx:method name="modify*" propagation="REQUIRED" isolation="DEFAULT"
                       rollback-for="java.lang.Exception" />
            <tx:method name="delete*" propagation="REQUIRED" isolation="DEFAULT"
                       rollback-for="java.lang.Exception" />

            <!-- 查询方法 -->
            <tx:method name="query*" read-only="true" />
            <tx:method name="select*" read-only="true" />
            <tx:method name="find*" read-only="true" />
        </tx:attributes>
    </tx:advice>

    <!-- 配置事务管理器 -->
    <bean id="txManager"
          class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource" />
    </bean>
  
    <!-- 声明式事务AOP配置 -->
    <aop:config>
        <aop:pointcut expression="execution(* com.itheima.service.impl.*.*(..))"
                      id="tranpointcut" />
        <!-- 事务控制 -->
        <aop:advisor advice-ref="txAdvice" pointcut-ref="tranpointcut" />
    </aop:config>
    <!--引入mybatis集成配置-->
    <import resource="spring-mybatis.xml" />
</beans>
```

##### 2.3.3 ProductService接口
```java
package com.itheima.service;

public interface ProductService {}
```

##### 2.3.4 ProductServiceImpl
```java
package com.itheima.service.impl;

import com.itheima.service.ProductService;
import org.springframework.stereotype.Service;

@Service
public class ProductServiceImpl implements ProductService {}
```

#### 2.4 ssm-web
##### 2.4.1 pom.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ssm-parent</artifactId>
        <groupId>com.itheima</groupId>
        <version>1.0-SNAPSHOT</version>
        <relativePath>../ssm-parent/pom.xml</relativePath>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>ssm-web</artifactId>
    <packaging>war</packaging>

    <dependencies>
        <!--依赖service-->
        <dependency>
            <groupId>com.itheima</groupId>
            <artifactId>ssm-service</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--springmvc-->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webmvc</artifactId>
        </dependency>
        <!--JSON转换-->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-core</artifactId>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
        </dependency>
        <!--servletAPI -->
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>servlet-api</artifactId>
            <scope>provided</scope>
        </dependency>

        <dependency>
            <groupId>javax.servlet.jsp</groupId>
            <artifactId>jsp-api</artifactId>
            <scope>provided</scope>
        </dependency>

        <dependency>
            <groupId>jstl</groupId>
            <artifactId>jstl</artifactId>
        </dependency>
    </dependencies>
</project>
```

##### 2.4.2 web.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://java.sun.com/xml/ns/javaee"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
         id="WebApp_ID" version="3.0">
    <!--POST编码过滤器-->
   <filter>
    <filter-name>characterEncodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>

    <!--指定编码-->
    <init-param>
      <param-name>encoding</param-name>
      <param-value>UTF-8</param-value>
    </init-param>
    <init-param>
      <param-name>forceEncoding</param-name>
      <param-value>true</param-value>
    </init-param>
  </filter>

  <!--编码映射拦截-->
  <filter-mapping>
    <filter-name>characterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>
```


​	


```xml
  <!--前端核心控制器-->
  <servlet>
    <servlet-name>springmvc</servlet-name>
    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>

    <!--指定springmvc核心配置文件-->
    <init-param>
      <param-name>contextConfigLocation</param-name>
      <param-value>classpath:springmvc.xml</param-value>
    </init-param>

    <!--启动加载优先级-->
    <load-on-startup>1</load-on-startup>
  </servlet>

  <!--映射拦截-->
  <servlet-mapping>
    <servlet-name>springmvc</servlet-name>
    <url-pattern>/</url-pattern>
  </servlet-mapping>

  <welcome-file-list>
    <welcome-file>index.shtml</welcome-file>
  </welcome-file-list>
</web-app>
```

##### 2.4.3 springmvc.xml

在ssm-web的resources下创建springmvc.xml，内容如下

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/mvc
       http://www.springframework.org/schema/mvc/spring-mvc.xsd
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!--包扫描-->
    <context:component-scan base-package="com.itheima" />

    <!--注解驱动-->
    <mvc:annotation-driven />

    <!--视图解析器-->
    <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <!--前缀-->
        <property name="prefix" value="/pages/" />
        <!--后缀-->
        <property name="suffix" value=".jsp" />
    </bean>

    <!--静态资源过滤-->
    <mvc:default-servlet-handler />

    <!--引入spring.xml-->
    <import resource="spring.xml" />
</beans>
```

##### 2.4.4 ProductController
```java
package com.itheima.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;

@Controller
@RequestMapping(value = "/product")
public class ProductController {}
```

##### 2.4.5 页面准备

复制 页面\ssm_pages\src\main\webapp目录下的目录和文件，除了WEB-INF外，其它所有文件都复制到ssm-web\src\main\webapp目录下

### 第3章 产品功能模块

#### 3.1 所有产品查询
##### 3.1.1 Controller实现
```java
@Controller
@RequestMapping(value = "/product")
public class ProductController {

    @Autowired
    private ProductService productService;

    /***
     * 商品列表查询
     * @param model
     * @return
     */
    @RequestMapping(value = "/list")
    public String list(Model model){
        //集合查询
        List<Product> products = productService.list();
        model.addAttribute("products",products);
        return "product-list";
    }
}
```

##### 3.1.2 Service实现
```java
//接口
public interface ProductService {	
    List<Product> list();
}

//接口实现
@Service
public class ProductServiceImpl implements ProductService {

    @Autowired
    private ProductDao productDao;

    @Override
    public List<Product> list() {
        return productDao.list();
    }
}
```

##### 3.1.3 Dao实现
```java
public interface ProductDao {
```

```java
    /**
     * 查询所有
     * @return
     */
    @Select("select * from product")
    List<Product> list();
}
```

##### 3.1.4 页面显示 product-list.jsp
```jsp
<!--数据列表-->
<table id="dataList"
	class="table table-bordered table-striped table-hover dataTable">
	<thead>
		<tr>
			<th class="" style="padding-right: 0px;"><input
				id="selall" type="checkbox" class="icheckbox_square-blue">
			</th>
			<th class="sorting">产品编号</th>
			<th class="sorting">产品名称</th>
			<th class="sorting">出发城市</th>
			<th class="sorting">出发日期</th>
			<th class="sorting">价格</th>
			<th class="sorting">描述</th>
			<th class="sorting">状态</th>
			<th class="text-center">操作</th>
		</tr>
	</thead>
	<tbody>
		<c:forEach items="${products}" var="product">
			<tr>
				<td><input name="ids" value="${product.id}" type="checkbox"></td>
				<td>${product.productNum}</td>
				<td>${product.productName}</td>
				<td>${product.cityName}</td>
				<td>
					${product.departureTime}
                </td>
				<td>${product.productPrice}</td>
				<td>${product.productDesc}</td>
				<td>
					${product.productStatus}
				</td>
				<td class="text-center">
					<button type="button" class="btn bg-olive btn-xs"
						onclick='del(${product.id})'>删除</button>
					<button type="button" class="btn bg-olive btn-xs"
						onclick='location.href="/product/one?id=${product.id}"'>查看</button>
				</td>
			</tr>
		</c:forEach>
	</tbody>
</table>
<!--数据列表/-->
```

##### 3.1.5 日期格式解决
JSP页面显示的日期为默认的英文日期，转换成字符串格式有2种方式。

###### 3.1.5.1 方案一
使用fmt标签进行转换

```jsp
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
```

```jsp
<fmt:formatDate value="${product.departureTime }" pattern="yyyy-MM-dd hh:mm:ss"/>
```

###### 3.1.5.2 方案二
在JavaBean中添加属性，重写该属性的get方法进行转换

```java
//添加该属性
private String departureTimeStr;

/**
 * 重写get方法，返回字符串类型的时间
 * @return
 */
public String getDepartureTimeStr() {
	if(departureTime == null) {
		return "";
	}else {
		return DateUtil.dateToStr(departureTime, DateUtil.ymdHm);
	}
}
```

##### 3.1.6 处理状态的问题
有2种方法实现

```jsp
<!--1 在JSP页面进行判断-->
<c:if test="${product.productStatus == 0 }">关闭</c:if>
<c:if test="${product.productStatus == 1 }">开启</c:if>
```

```java
// 2 在JavaBean中添加属性，重写get方法
private String productStatusStr;
public String getProductStatusStr() {
	return productStatus == 0?"关闭":"开启";
}
```

#### 3.2 添加产品

##### 3.2.1 Controller
在ProductController中增加2个方法，一个是跳转到增加页面，一个是实现增加，他们的访问路径一致，提交方式不一样。

```java
/***
 * 新增页面跳转
 */
@RequestMapping(value = "/initAdd")
public String initAdd(){
    // 为什么独立出一个请求的方法:
    //方便以后的权限控制，如果登陆的用户没有 添加 的权限，就会进入拦截里，如果只是在页面做页面之间的跳转则不利于后期的权限控制 
    return "product-add";
}
```


```java
/***
 * 增加操作
 * @return
 */
@RequestMapping(value = "/add")
public String add(Product product){

    //增加数据
    int count = productService.add(product);
    return "redirect:/product/list";
}
```

##### 3.2.2 Service
新增一个add方法

```java
//接口
int add(Product product);

//实现类
@Override
public int add(Product product) {
    return productDao.add(product);
}
```

##### 3.2.3 Dao
新增一个add方法，这里我们用到了序列，使用的是@SelectKey注解实现序列调用

```java
/***
 * 增加操作
 * @param product
 * @return
 */
@SelectKey(statement = "SELECT PRODUCT_SEQ.NEXTVAL FROM dual", keyProperty = "id", before = true, resultType =Integer.class)
@Insert("insert into product(id,productNum,productName,cityName,departureTime,productPrice,productDesc,productStatus)values(#{id},#{productNum},#{productName},#{cityName},#{departureTime},#{productPrice},#{productDesc},#{productStatus})")
int add(Product product);
```

除了以上使用selectKey的方式外，我们还可以直接调用序列的nextval方式，做法如下，把#{id}改成PRODUCT_SEQ.NEXTVAL即可

```java
@Insert("insert into product(id,productNum,productName,cityName,departureTime,productPrice,productDesc,productStatus)values(PRODUCT_SEQ.NEXTVAL,#{productNum},#{productName},#{cityName},#{departureTime},#{productPrice},#{productDesc},#{productStatus})")
int add(Product product);
```



##### 3.2.4 页面 product-add.jsp

```jsp
<form action="${pageContext.request.contextPath}/product/add" method="post">
	<!-- 正文区域 -->
	<section class="content"> <!--产品信息-->

	<div class="panel panel-default">
		<div class="panel-heading">产品信息</div>
		<div class="row data-type">

			<div class="col-md-2 title">产品编号</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" name="productNum"
					placeholder="产品编号" value="">
			</div>
			<div class="col-md-2 title">产品名称</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" name="productName"
					placeholder="产品名称" value="">
			</div>
			<div class="col-md-2 title">出发时间</div>
			<div class="col-md-4 data">
				<div class="input-group date">
					<div class="input-group-addon">
						<i class="fa fa-calendar"></i>
					</div>
					<input type="text" class="form-control pull-right"
						id="datepicker-a3" name="departureTime">
				</div>
			</div>
```


```jsp
			<div class="col-md-2 title">出发城市</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" name="cityName"
					placeholder="出发城市" value="">
			</div>

			<div class="col-md-2 title">产品价格</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" placeholder="产品价格"
					name="productPrice" value="">
			</div>

			<div class="col-md-2 title">产品状态</div>
			<div class="col-md-4 data">
				<select class="form-control select2" style="width: 100%"
					name="productStatus">
					<option value="0" selected="selected">关闭</option>
					<option value="1">开启</option>
				</select>
			</div>

			<div class="col-md-2 title rowHeight2x">其他信息</div>
			<div class="col-md-10 data rowHeight2x">
				<textarea class="form-control" rows="3" placeholder="其他信息"
					name="productDesc"></textarea>
			</div>

		</div>
	</div>
	<!--订单信息/--> <!--工具栏-->
	<div class="box-tools text-center">
		<button type="submit" class="btn bg-maroon">保存</button>
		<button type="button" class="btn bg-default"
			onclick="history.back(-1);">返回</button>
	</div>
	<!--工具栏/--> </section>
	<!-- 正文区域 /-->
</form>
```

##### 3.2.5 解决日期问题
在进行数据绑定的时候，日期出现了异常，该格式的日期不支持默认数据类型转换
###### 3.2.5.1 自定义类型转换器
自定义类型转换器（比较麻烦，回去看第一天文档）

###### 3.2.5.2 在departureTime属性上添加注解解决
```java
@DateTimeFormat(pattern="yyyy-MM-dd HH:mm")
private Date departureTime;
```

###### 3.2.5.3 @InitBinder
在Controller类中添加方法，进行类型转换

```java
/**
 * 类型转换
 * @param dataBinder
 */
@InitBinder
public void initBinderDate(WebDataBinder dataBinder) {
	dataBinder.registerCustomEditor(Date.class, new PropertiesEditor() {
		// JSP页面传过来的数据
		public void setAsText(String text) throws IllegalArgumentException {
			// 把字符串转换成日期
			SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm");
			try {
				Date date = sdf.parse(text);
				// 设置值
				super.setValue(date);
			} catch (ParseException e) {
				e.printStackTrace();
			}
		}
	});
}
```

#### 3.3 修改产品
#### 3.3.1 Controller
增加2个方法，一个是根据id查询产品，一个是保存方法

```java
/***
 * 修改产品
 * @return
 */
@RequestMapping(value = "/update")
public String update(Product product){
    int mcount = productService.update(product);
    return "redirect:/product/list";
}

/**
 * 修改产品 回显
 * 通过编号查询产品信息
 * @param id
 * @param model
 * @return
 */
@RequestMapping("/initUpdate")
public String initUpdate(Long id,Model model){
    Product product = productService.getById(id);
    model.addAttribute("product",product);
    return "product-update";
}
```

##### 3.3.2 Service
分别在接口和实现类中新增2个方法

```java
//接口 ProductService
Product getById(Long id);
int update(Product product); 

//实现类 ProductServiceImpl
@Override
public Product getById(Long id) {
    return productDao.getById(id);
}

@Override
public int update(Product product) {
    return productDao.update(product);
}
```

##### 3.3.3 Dao
新增2个方法，一个根据ID查询，一个修改方法。

```java
/**
 * 根据ID查询
 * @param id
 * @return
 */
@Select("select * from product where id=#{id}")
Product getById(Long id);

/***
 * 修改操作
 * @param product
 * @return
 */
@Update("update product set productNum = #{productNum},productName=#{productName},cityName=#{cityName},departureTime=#{departureTime},productPrice=#{productPrice},productDesc=#{productDesc},productStatus=#{productStatus} where id = #{id}")
int update(Product product);
```

##### 3.3.4 页面 product-update.jsp
```jsp
<form action="${pageContext.request.contextPath}/product/update" method="post">
	<input type="hidden" name="id" value="${product.id}">
	<!-- 正文区域 -->
	<section class="content"> <!--产品信息-->

	<div class="panel panel-default">
		<div class="panel-heading">产品信息</div>
		<div class="row data-type">

			<div class="col-md-2 title">产品编号</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" name="productNum"
					placeholder="产品编号" value="${product.productNum}"
					readonly="readonly">
			</div>
			<div class="col-md-2 title">产品名称</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" name="productName"
					placeholder="产品名称" value="${product.productName}">
			</div>
			<div class="col-md-2 title">出发时间</div>
			<div class="col-md-4 data">
				<div class="input-group date">
					<div class="input-group-addon">
						<i class="fa fa-calendar"></i>
					</div>
					<input type="text" class="form-control pull-right"
						id="datepicker-a3" name="departureTime"
						value="${product.departureTimeStr}">
				</div>
			</div>
```


```jsp
			<div class="col-md-2 title">出发城市</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" name="cityName"
					placeholder="出发城市" value="${product.cityName}">
			</div>

			<div class="col-md-2 title">产品价格</div>
			<div class="col-md-4 data">
				<input type="text" class="form-control" placeholder="产品价格"
					name="productPrice" value="${product.productPrice}">
			</div>

			<div class="col-md-2 title">产品状态</div>
			<div class="col-md-4 data">
				<select class="form-control select2" style="width: 100%"
					name="productStatus">
					<option value="0" selected="selected">关闭</option>
					<option value="1">开启</option>
				</select>
			</div>

			<div class="col-md-2 title rowHeight2x">其他信息</div>
			<div class="col-md-10 data rowHeight2x">
				<textarea class="form-control" rows="3" placeholder="其他信息"
					name="productDesc">${product.productDesc}</textarea>
			</div>

		</div>
	</div>
	<!--订单信息/--> <!--工具栏-->
	<div class="box-tools text-center">
		<button type="submit" class="btn bg-maroon">修改</button>
		<button type="button" class="btn bg-default"
			onclick="history.back(-1);">返回</button>
	</div>
	<!--工具栏/--> </section>
	<!-- 正文区域 /-->
</form>
```

#### 3.4 删除产品
##### 3.4.1 Controller层
```java
/***
 * 根据ID删除
 * @param id
 * @return
 */
@RequestMapping(value = "/delete")
public String delete(Integer id){
    int dcount = productService.deleteById(id);
    return "redirect:/product/list";
}
```

##### 3.4.2 Service层
```java
//接口
int deleteById(Integer id);

//实现类
@Override
public int deleteById(Integer id) {
    return productDao.deleteById(id);
}
```

##### 3.4.3 Dao层
```java
/***
 * 删除操作
 * @param id
 * @return
 */
@Delete("delete from product where id=#{id}")
int deleteById(Integer id);
```

##### 3.4.4 页面修改

修改product-list.jsp，操作的列中修改按钮后添加删除按钮的调用方法

```jsp
<td class="text-center">
    <button type="button" class="btn bg-olive btn-xs" onclick='location.href="/product/initUpdate?id=${product.id}"'>修改</button>
	<button type="button" class="btn bg-olive btn-xs" onclick='del(${product.id})'>删除</button>
</td>
```

且在页面最后的js中添加del方法，用于删除时的方法调用

```javascript
function del(id){
    // 防呆判断，避免误删
	if(confirm("确认要删除吗")){
		location.href = "/product/delete?id=" + id;
	}
}
```

### 第4章 订单模块功能

#### 4.1 订单表与产品表的关系
1. 一个用户只会产生一个订单，一个订单只能选择一个产品，因为是旅游产品。
2. 一个产品可以被多个订单所选择。
3. 订单表与产品表的关系是多对一
4. 订单表的SQL语句
5. 订单表信息描述 orders

|  序号  |    字段名称     |     字段类型      |         字段描述          |
| :--: | :---------: | :-----------: | :-------------------: |
|  1   |     id      |    number     |        主键，自动增长        |
|  2   |  orderNum   | varchar2(50)  |      订单编号，不为空且唯一      |
|  3   |  orderTime  |   timestamp   |         下单时间          |
|  4   | peopleCount |    number     |         出行人数          |
|  5   |  orderDesc  | varchar2(500) |      订单描述（其它信息）       |
|  6   |   payType   |   number(1)   | 支付类型（0：支付宝，1：微信，2：其它） |
|  7   | orderStatus |   number(1)   |   订单状态（0：未支付，1：已支付）   |
|  8   |  productId  |    number     |        对应产品编号         |

productId描述了订单与产品之间的关系。

#### 4.2 创建表sql
```plsql
--创建订单表
create table orders(
       id number(20) primary key,
       orderNum varchar2(20) NOT NULL UNIQUE,
       orderTime date,
       peopleCount number(5),
       orderDesc varchar2(500),
       payType number(1),
       orderStatus number(1),
       productId number(20)
);

--创建序列
create sequence orders_seq;
```

#### 4.3 搭建订单模块的环境
##### 4.3.1 创建Orders

```java
public class Orders {    
	private Long id;
    private String orderNum;
    @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm")
    private Date orderTime;
    private Integer peopleCount;
    private String orderDesc;
    private Integer payType;
    private Integer orderStatus;
    //private Long productId;
    //一对一映射关系
    private Product product;
	//get..set..toString
}
```

##### 4.3.2 订单查询
###### 4.3.2.1 创建Controller
```java
@Controller
@RequestMapping(value = "/orders")
public class OrdersController {

    @Autowired
    private OrdersService ordersService;

    /***
     * 订单列表
     * @param model
     * @return
     */
    @RequestMapping(value = "/list")
    public String list(Model model){
        List<Orders> orders = ordersService.list();
        model.addAttribute("orders",orders);
        return "order-list";
    }
}
```

###### 4.3.2.2 Service
```java
//接口
public interface OrdersService {
    List<Orders> list();
}
```


```java
//实现类
@Service
public class OrdersServiceImpl implements OrdersService {

    @Autowired
    private OrdersDao ordersDao;

    @Override
    public List<Orders> list() {
        return ordersDao.list();
    }
}
```

###### 4.3.2.3 Dao
```java
public interface OrdersDao {
    /**
     * 查询所有
     *
     * @return
     */
    @Select("select o.id as oid,o.orderNum,o.orderTime,o.peopleCount,o.orderDesc,o.payType,o.orderStatus,p.* from orders o,product p where o.productId = p.id")
    @Results(value = {
            @Result(id = true, property = "id", column = "oid"),
            @Result(property = "orderNum", column = "orderNum"),
            @Result(property = "orderTime", column = "orderTime"),
            @Result(property = "peopleCount", column = "peopleCount"),
            @Result(property = "orderDesc", column = "orderDesc"),
            @Result(property = "payType", column = "payType"),
            @Result(property = "orderStatus", column = "orderStatus"),
            @Result(property = "product.id", column = "id"),
            @Result(property = "product.productNum", column = "productNum"),
            @Result(property = "product.productName", column = "productName"),
            @Result(property = "product.cityName", column = "cityName"),
            @Result(property = "product.departureTime", column = "departureTime"),
            @Result(property = "product.productPrice", column = "productPrice"),
            @Result(property = "product.productDesc", column = "productDesc"),
            @Result(property = "product.productStatus", column = "productStatus")
    })
    List<Orders> list();

}
```

###### 4.3.2.4 页面 order-list.jsp
```jsp
<table id="dataList"
							class="table table-bordered table-striped table-hover dataTable">
							<thead>
								<tr>
									<th class="" style="padding-right: 0px;"><input
										id="selall" type="checkbox" class="icheckbox_square-blue">
									</th>
									<th class="sorting">订单编号</th>
									<th class="sorting">路线名称</th>
									<th class="sorting">出发城市</th>
									<th class="sorting">出发日期</th>
									<th class="sorting">价格</th>
									<th class="sorting">出游人数</th>
									<th class="sorting">支付状态</th>
									<th class="sorting">支付类型</th>
									<th class="text-center">操作</th>
								</tr>
							</thead>
							<tbody>
								<c:forEach items="${orders}" var="orders">
								<tr>
									<td><input name="ids" type="checkbox"></td>
									<td>${orders.orderNum}</td>

									<td>${orders.product.productName}</td>
									<td>${orders.product.cityName}</td>
									<td>${orders.product.departureTimeStr}</td>
									<td>${orders.product.productPrice}</td>
									<td>${orders.peopleCount}</td>
									<td><c:if test="${orders.orderStatus==0}">未支付</c:if><c:if test="${orders.orderStatus==1}">已支付</c:if></td>
									<td>
										<c:choose>
											<c:when test="${orders.payType == 0}">支付宝</c:when>
											<c:when test="${orders.payType == 1}">微信</c:when>
											<c:otherwise>其它</c:otherwise>
										</c:choose>
									</td>
									<td class="text-center">
										<button type="button" class="btn bg-olive btn-xs"
											onclick='location.href="${pageContext.request.contextPath}/pages/order-show.jsp"'>订单</button>
										<button type="button" class="btn bg-olive btn-xs"
											onclick='location.href="${pageContext.request.contextPath}/pages/order-show.jsp"'>查看</button>
									</td>
								</tr>
								</c:forEach>

							</tbody>

						</table>
```

##### 4.3.3 新增订单
###### 4.3.3.1 Controller
新增2个方法，分别实现页面跳转和保存订单操作。在这里，页面需要加载产品信息供用户选择，所以需要注入ProductService来实现查询.

```java
@Autowired
private ProductService productService;

/**
 * 保存操作
 * @param orders
 * @return
 */
@RequestMapping(value = "/add",method = RequestMethod.POST)
public String add(Orders orders){
    int acount = ordersService.add(orders);
    return "redirect:/orders/list";
}

/***
 * 增加订单页面跳转
 * @return
 */
@RequestMapping(value = "/initAdd",method = RequestMethod.GET)
public String initAdd(Model model){
    //查询所有产品信息，页面需要提供产品下拉列表，所以需要注入ProductService来实现查询所有的产品
    List<Product> products = productService.list();
    model.addAttribute("products",products);
    return "order-add";
}
```

###### 4.3.3.2 Service
```java
//接口
int add(Orders orders);

//实现类
@Override
public int add(Orders orders) {
    return ordersDao.add(orders);
}
```

###### 4.3.3.3 Dao
```java
/**
 * 插入数据操作
 * @param orders
 * @return
 */
@Insert("insert into orders (id,orderNum,orderTime,peopleCount,orderDesc,payType,orderStatus,productId) values (ORDERS_SEQ.NEXTVAL,#{orderNum},#{orderTime},#{peopleCount},#{orderDesc},#{payType},#{orderStatus},#{product.id})")
int add(Orders orders);
```


​	

重点：

	增加订单
	订单查询
	时间格式处理
	使用SelectKey查询序列
	熟练@Insert、@Select、@Update、@Delete注解的使用

​	